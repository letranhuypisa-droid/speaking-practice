<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Speaking Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .recording { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="app" class="min-h-screen">
        <div id="loading" class="flex items-center justify-center min-h-screen">
            <div class="text-center text-white">
                <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-xl">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // CONFIGURATION - THAY ƒê·ªîI TH√îNG TIN C·ª¶A B·∫†N
        // ============================================
        const CONFIG = {
    SUPABASE_URL: 'https://ixwiqbacxizbmmhywvjk.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4d2lxYmFjeGl6Ym1taHl3dmprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjY1NTYsImV4cCI6MjA4MzgwMjU1Nn0.NxnmtKt_Enmo_nbXnaj1JEeNHgFrI0KKIvUayGqI5vo',
    GEMINI_API_KEY: 'AIzaSyA990iSYKZ79J0kd1Ro884W9o5sH85PeWM'
};

        // ============================================
        // GLOBAL ERROR HANDLER
        // ============================================
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.log('Error: ' + msg);
            console.log('URL: ' + url);
            console.log('Line: ' + lineNo);
            return false;
        };

        // ============================================
        // APP STATE
        // ============================================
        let db = null;
        let currentUser = null;
        let currentProfile = null;
        let questions = [];
        let categories = [];
        let currentQuestion = null;
        let recognition = null;
        let isRecording = false;
        let transcript = '';

        // ============================================
        // INITIALIZE SUPABASE
        // ============================================
        function initSupabase() {
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase library not loaded');
                showError('Failed to load Supabase library. Please refresh the page.');
                return false;
            }
            
            try {
                db = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
                return true;
            } catch (err) {
                console.error('Supabase init error:', err);
                showError('Failed to initialize Supabase: ' + err.message);
                return false;
            }
        }

        function showError(message) {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass rounded-2xl p-8 max-w-lg text-center">
                        <div class="text-5xl mb-4">‚ùå</div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-4">Error</h1>
                        <p class="text-gray-600">${message}</p>
                        <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-purple-500 text-white rounded-lg">
                            Refresh Page
                        </button>
                    </div>
                </div>
            `;
        }

        // ============================================
        // TEMPLATES
        // ============================================
        function getAuthTemplate() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-800">English Speaking Practice</h1>
                            <p class="text-gray-600 mt-2">Practice speaking with AI feedback</p>
                        </div>
                        
                        <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                            <button onclick="showLoginTab()" id="login-tab-btn" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all bg-white shadow text-gray-800">Login</button>
                            <button onclick="showRegisterTab()" id="register-tab-btn" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all text-gray-600">Register</button>
                        </div>

                        <div id="login-form-container">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="login-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                    <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <button onclick="doLogin()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:opacity-90 transition-opacity">
                                    Login
                                </button>
                            </div>
                        </div>

                        <div id="register-form-container" class="hidden">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                    <input type="text" id="register-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="John Doe">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="register-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Password (min 6 characters)</label>
                                    <input type="password" id="register-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">I am a...</label>
                                    <select id="register-role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="student">Student</option>
                                        <option value="teacher">Teacher</option>
                                    </select>
                                </div>
                                <button onclick="doRegister()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:opacity-90 transition-opacity">
                                    Create Account
                                </button>
                            </div>
                        </div>

                        <div id="auth-message" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
                    </div>
                </div>
            `;
        }

        function getDashboardTemplate() {
            return `
                <div class="min-h-screen">
                    <header class="glass sticky top-0 z-50 shadow-sm">
                        <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                    </svg>
                                </div>
                                <span class="font-bold text-gray-800 hidden sm:inline">Speaking Practice</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-gray-600 hidden sm:inline">Hi, <strong id="header-user-name">User</strong></span>
                                <span id="header-user-role" class="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded-full">student</span>
                                <button onclick="doLogout()" class="text-sm text-gray-500 hover:text-gray-700">Logout</button>
                            </div>
                        </div>
                    </header>

                    <nav class="glass border-b">
                        <div class="max-w-6xl mx-auto px-4">
                            <div class="flex gap-1">
                                <button onclick="navigateTo('practice')" id="nav-practice" class="nav-btn px-4 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-600">
                                    üé§ Practice
                                </button>
                                <button onclick="navigateTo('history')" id="nav-history" class="nav-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-purple-600">
                                    üìä Results
                                </button>
                                <button onclick="navigateTo('admin')" id="nav-admin" class="nav-btn hidden px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-600 hover:text-purple-600">
                                    ‚öôÔ∏è Manage
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main class="max-w-6xl mx-auto px-4 py-8">
                        <div id="main-content"></div>
                    </main>
                </div>
            `;
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        function showLoginTab() {
            document.getElementById('login-form-container').classList.remove('hidden');
            document.getElementById('register-form-container').classList.add('hidden');
            document.getElementById('login-tab-btn').classList.add('bg-white', 'shadow', 'text-gray-800');
            document.getElementById('login-tab-btn').classList.remove('text-gray-600');
            document.getElementById('register-tab-btn').classList.remove('bg-white', 'shadow', 'text-gray-800');
            document.getElementById('register-tab-btn').classList.add('text-gray-600');
            hideAuthMessage();
        }

        function showRegisterTab() {
            document.getElementById('login-form-container').classList.add('hidden');
            document.getElementById('register-form-container').classList.remove('hidden');
            document.getElementById('register-tab-btn').classList.add('bg-white', 'shadow', 'text-gray-800');
            document.getElementById('register-tab-btn').classList.remove('text-gray-600');
            document.getElementById('login-tab-btn').classList.remove('bg-white', 'shadow', 'text-gray-800');
            document.getElementById('login-tab-btn').classList.add('text-gray-600');
            hideAuthMessage();
        }

        function showAuthMessage(message, isError) {
            const el = document.getElementById('auth-message');
            if (el) {
                el.textContent = message;
                el.className = `mt-4 p-3 rounded-lg text-sm ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
                el.classList.remove('hidden');
            }
        }

        function hideAuthMessage() {
            const el = document.getElementById('auth-message');
            if (el) el.classList.add('hidden');
        }

        async function doLogin() {
            hideAuthMessage();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showAuthMessage('Please enter email and password', true);
                return;
            }

            try {
                const { data, error } = await db.auth.signInWithPassword({ email, password });
                if (error) {
                    showAuthMessage(error.message, true);
                }
            } catch (err) {
                showAuthMessage('Connection error. Please try again.', true);
            }
        }

        async function doRegister() {
            hideAuthMessage();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;

            if (!name || !email || !password) {
                showAuthMessage('Please fill in all fields', true);
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters', true);
                return;
            }

            try {
                const { data, error } = await db.auth.signUp({
                    email,
                    password,
                    options: {
                        data: { full_name: name, role: role }
                    }
                });

                if (error) {
                    showAuthMessage(error.message, true);
                } else {
                    showAuthMessage('Account created! You can now login.', false);
                    setTimeout(showLoginTab, 2000);
                }
            } catch (err) {
                showAuthMessage('Connection error. Please try again.', true);
            }
        }

        async function doLogout() {
            await db.auth.signOut();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function navigateTo(page) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            const activeNav = document.getElementById('nav-' + page);
            if (activeNav) {
                activeNav.classList.add('border-purple-500', 'text-purple-600');
                activeNav.classList.remove('border-transparent', 'text-gray-600');
            }

            // Load page content
            if (page === 'practice') {
                loadPracticePage();
            } else if (page === 'history') {
                loadHistoryPage();
            } else if (page === 'admin') {
                loadAdminPage();
            }
        }

        // ============================================
        // PRACTICE PAGE
        // ============================================
        async function loadPracticePage() {
            document.getElementById('main-content').innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-white mb-6">Choose a Topic</h2>
                    <div id="categories-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div class="text-white text-center p-4">Loading categories...</div>
                    </div>
                    <div id="questions-container" class="hidden"></div>
                    <div id="practice-container" class="hidden"></div>
                </div>
            `;

            await loadCategories();
        }

        async function loadCategories() {
            try {
                const { data, error } = await db.from('categories').select('*').order('name');
                if (error) throw error;

                categories = data || [];
                const container = document.getElementById('categories-container');

                if (categories.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-white text-center p-8">No categories found. Please run the SQL setup script.</div>';
                    return;
                }

                container.innerHTML = categories.map(cat => `
                    <div onclick="openCategory('${cat.id}')" class="glass rounded-xl p-4 text-center hover:scale-105 transition-transform cursor-pointer">
                        <div class="text-3xl mb-2">${cat.icon || 'üìö'}</div>
                        <div class="font-medium text-gray-800 text-sm">${cat.name}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load categories error:', err);
                document.getElementById('categories-container').innerHTML = '<div class="col-span-full text-white text-center p-8">Error loading categories</div>';
            }
        }

        async function openCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            
            document.getElementById('categories-container').classList.add('hidden');
            document.getElementById('questions-container').classList.remove('hidden');
            
            document.getElementById('questions-container').innerHTML = `
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-white">${category?.icon || 'üìö'} ${category?.name || 'Questions'}</h3>
                    <button onclick="backToCategories()" class="text-white/80 hover:text-white text-sm">‚Üê Back</button>
                </div>
                <div id="questions-list" class="grid gap-4">
                    <div class="text-white text-center p-4">Loading questions...</div>
                </div>
            `;

            try {
                const { data, error } = await db
                    .from('questions')
                    .select('*')
                    .eq('category_id', categoryId)
                    .eq('is_active', true)
                    .order('created_at');

                if (error) throw error;

                questions = data || [];
                const list = document.getElementById('questions-list');

                if (questions.length === 0) {
                    list.innerHTML = '<div class="glass rounded-xl p-8 text-center text-gray-500">No questions in this category yet.</div>';
                    return;
                }

                list.innerHTML = questions.map(q => `
                    <div onclick="openQuestion('${q.id}')" class="glass rounded-xl p-4 hover:scale-[1.01] transition-transform cursor-pointer">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-800">${q.title}</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${getDifficultyClass(q.difficulty)}">${q.difficulty}</span>
                        </div>
                        <p class="text-sm text-gray-600">${q.question_text}</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load questions error:', err);
                document.getElementById('questions-list').innerHTML = '<div class="text-white text-center p-4">Error loading questions</div>';
            }
        }

        function getDifficultyClass(difficulty) {
            if (difficulty === 'easy') return 'bg-green-100 text-green-700';
            if (difficulty === 'hard') return 'bg-red-100 text-red-700';
            return 'bg-yellow-100 text-yellow-700';
        }

        function backToCategories() {
            document.getElementById('categories-container').classList.remove('hidden');
            document.getElementById('questions-container').classList.add('hidden');
            document.getElementById('practice-container').classList.add('hidden');
            stopRecording();
        }

        function backToQuestionsList() {
            document.getElementById('questions-container').classList.remove('hidden');
            document.getElementById('practice-container').classList.add('hidden');
            stopRecording();
        }

        function openQuestion(questionId) {
            currentQuestion = questions.find(q => q.id === questionId);
            if (!currentQuestion) return;

            const category = categories.find(c => c.id === currentQuestion.category_id);

            document.getElementById('questions-container').classList.add('hidden');
            document.getElementById('practice-container').classList.remove('hidden');

            document.getElementById('practice-container').innerHTML = `
                <button onclick="backToQuestionsList()" class="text-white/80 hover:text-white text-sm mb-4">‚Üê Back to questions</button>
                
                <!-- Question Card -->
                <div class="glass rounded-2xl p-6 mb-6">
                    <div class="flex items-start gap-4 mb-4">
                        <span class="text-3xl">${category?.icon || '‚ùì'}</span>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${currentQuestion.title}</h3>
                            <span class="text-xs px-2 py-1 rounded-full ${getDifficultyClass(currentQuestion.difficulty)}">${currentQuestion.difficulty}</span>
                        </div>
                    </div>
                    <p class="text-lg text-gray-700 mb-4">${currentQuestion.question_text}</p>
                    
                    ${currentQuestion.tips ? `
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 mb-4">
                            <p class="text-sm text-yellow-800"><strong>üí° Tip:</strong> ${currentQuestion.tips}</p>
                        </div>
                    ` : ''}
                    
                    ${currentQuestion.sample_answer ? `
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <button onclick="toggleSampleAnswer()" class="text-sm text-blue-700 font-medium">
                                üëÅÔ∏è <span id="sample-toggle-text">Show sample answer</span>
                            </button>
                            <p id="sample-answer-text" class="hidden mt-3 text-sm text-blue-800">${currentQuestion.sample_answer}</p>
                        </div>
                    ` : ''}
                </div>

                <!-- Recording Card -->
                <div class="glass rounded-2xl p-6 mb-6">
                    <h4 class="font-semibold text-gray-800 mb-4">Your Answer</h4>
                    
                    <div class="flex flex-col items-center mb-6">
                        <button id="record-button" onclick="toggleRecording()" class="w-24 h-24 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white flex items-center justify-center shadow-lg hover:opacity-90 transition-all">
                            <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </button>
                        <p id="record-status" class="mt-4 text-gray-600 text-center">Click to start recording<br><span class="text-xs text-gray-400">(Chrome/Edge recommended)</span></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your answer (you can type or edit here):</label>
                        <textarea id="answer-text" class="w-full h-32 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Speak or type your answer here..."></textarea>
                        
                        <div class="flex gap-3 mt-4">
                            <button onclick="submitForGrading()" id="submit-button" class="flex-1 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg font-medium hover:opacity-90">
                                ‚ú® Get AI Feedback
                            </button>
                            <button onclick="clearAnswer()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Card (Hidden initially) -->
                <div id="results-card" class="hidden glass rounded-2xl p-6 fade-in">
                    <h4 class="font-semibold text-gray-800 mb-6">AI Feedback</h4>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl">
                            <div class="text-3xl font-bold text-purple-600" id="score-overall">--</div>
                            <div class="text-sm text-purple-600">Overall</div>
                        </div>
                        <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
                            <div class="text-3xl font-bold text-blue-600" id="score-grammar">--</div>
                            <div class="text-sm text-blue-600">Grammar</div>
                        </div>
                        <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl">
                            <div class="text-3xl font-bold text-green-600" id="score-content">--</div>
                            <div class="text-sm text-green-600">Content</div>
                        </div>
                        <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl">
                            <div class="text-3xl font-bold text-orange-600" id="score-vocab">--</div>
                            <div class="text-sm text-orange-600">Vocabulary</div>
                        </div>
                    </div>

                    <div class="p-4 bg-gray-50 rounded-xl mb-6">
                        <h5 class="font-medium text-gray-800 mb-2">Detailed Feedback</h5>
                        <div id="feedback-content" class="text-gray-700 whitespace-pre-wrap"></div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="backToCategories()" class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:opacity-90">
                            üîÑ New Question
                        </button>
                        <button onclick="retryCurrentQuestion()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300">
                            üîÅ Retry
                        </button>
                    </div>
                </div>
            `;

            transcript = '';
        }

        function toggleSampleAnswer() {
            const text = document.getElementById('sample-answer-text');
            const toggle = document.getElementById('sample-toggle-text');
            if (text.classList.contains('hidden')) {
                text.classList.remove('hidden');
                toggle.textContent = 'Hide sample answer';
            } else {
                text.classList.add('hidden');
                toggle.textContent = 'Show sample answer';
            }
        }

        function clearAnswer() {
            transcript = '';
            const textarea = document.getElementById('answer-text');
            if (textarea) textarea.value = '';
        }

        function retryCurrentQuestion() {
            document.getElementById('results-card').classList.add('hidden');
            clearAnswer();
        }

        // ============================================
        // SPEECH RECOGNITION
        // ============================================
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.log('Speech recognition not supported');
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = function(event) {
                let final = '';
                let interim = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        final += event.results[i][0].transcript;
                    } else {
                        interim += event.results[i][0].transcript;
                    }
                }

                if (final) {
                    transcript += final + ' ';
                }

                const textarea = document.getElementById('answer-text');
                if (textarea) {
                    textarea.value = transcript + interim;
                }
            };

            recognition.onerror = function(event) {
                console.log('Speech error:', event.error);
                if (event.error !== 'no-speech' && event.error !== 'aborted') {
                    stopRecording();
                }
            };

            recognition.onend = function() {
                if (isRecording) {
                    try { recognition.start(); } catch(e) {}
                }
            };

            return true;
        }

        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert('Speech recognition not supported. Please type your answer instead.');
                    return;
                }
            }

            try {
                isRecording = true;
                recognition.start();

                const btn = document.getElementById('record-button');
                if (btn) {
                    btn.classList.add('recording');
                    btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                }

                const status = document.getElementById('record-status');
                if (status) {
                    status.innerHTML = 'üî¥ Recording... Click to stop';
                }
            } catch (e) {
                console.log('Start recording error:', e);
                isRecording = false;
            }
        }

        function stopRecording() {
            isRecording = false;

            if (recognition) {
                try { recognition.stop(); } catch(e) {}
            }

            const btn = document.getElementById('record-button');
            if (btn) {
                btn.classList.remove('recording');
                btn.style.background = 'linear-gradient(135deg, #8b5cf6, #ec4899)';
            }

            const status = document.getElementById('record-status');
            if (status) {
                status.innerHTML = 'Click to start recording<br><span class="text-xs text-gray-400">(Chrome/Edge recommended)</span>';
            }

            const textarea = document.getElementById('answer-text');
            if (textarea) {
                transcript = textarea.value;
            }
        }

        // ============================================
        // AI GRADING
        // ============================================
        async function submitForGrading() {
            const textarea = document.getElementById('answer-text');
            const answer = textarea ? textarea.value.trim() : '';

            if (!answer) {
                alert('Please provide an answer first.');
                return;
            }

            if (answer.split(' ').length < 3) {
                alert('Please provide a longer answer.');
                return;
            }

            stopRecording();

            const submitBtn = document.getElementById('submit-button');
            submitBtn.innerHTML = '‚è≥ Analyzing...';
            submitBtn.disabled = true;

            try {
                const result = await callGeminiAPI(currentQuestion.question_text, answer, currentQuestion.sample_answer);
                await saveResultToDatabase(result, answer);
                displayGradingResult(result);
            } catch (error) {
                console.error('Grading error:', error);
                alert('Error: ' + error.message);
            } finally {
                submitBtn.innerHTML = '‚ú® Get AI Feedback';
                submitBtn.disabled = false;
            }
        }

        async function callGeminiAPI(question, answer, sampleAnswer) {
            const prompt = `You are an English speaking test evaluator. Grade this student's spoken response.

Question: "${question}"
Student's Answer: "${answer}"
${sampleAnswer ? `Reference Answer: "${sampleAnswer}"` : ''}

Evaluate based on:
1. Grammar (0-100): Sentence structure, tenses, articles, prepositions
2. Content (0-100): Relevance, coherence, idea development  
3. Vocabulary (0-100): Range and appropriateness
4. Overall (0-100): Combined assessment

RESPOND ONLY WITH THIS JSON FORMAT:
{
    "overall_score": <number>,
    "grammar_score": <number>,
    "content_score": <number>,
    "vocabulary_score": <number>,
    "feedback": "<2-3 paragraphs with specific feedback>"
}`;

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3, maxOutputTokens: 1024 }
                    })
                }
            );

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'API request failed');
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!text) {
                throw new Error('Empty API response');
            }

            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Could not parse response');
            }

            return JSON.parse(jsonMatch[0]);
        }

        async function saveResultToDatabase(result, answer) {
            try {
                await db.from('results').insert({
                    student_id: currentUser.id,
                    question_id: currentQuestion.id,
                    student_answer: answer,
                    score: result.overall_score,
                    grammar_score: result.grammar_score,
                    content_score: result.content_score,
                    vocabulary_score: result.vocabulary_score,
                    feedback: result.feedback
                });
            } catch (err) {
                console.error('Save result error:', err);
            }
        }

        function displayGradingResult(result) {
            document.getElementById('score-overall').textContent = result.overall_score;
            document.getElementById('score-grammar').textContent = result.grammar_score;
            document.getElementById('score-content').textContent = result.content_score;
            document.getElementById('score-vocab').textContent = result.vocabulary_score;
            document.getElementById('feedback-content').textContent = result.feedback;

            document.getElementById('results-card').classList.remove('hidden');
            document.getElementById('results-card').scrollIntoView({ behavior: 'smooth' });
        }

        // ============================================
        // HISTORY PAGE
        // ============================================
        async function loadHistoryPage() {
            document.getElementById('main-content').innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-white mb-6">My Practice History</h2>
                    
                    <div class="glass rounded-2xl p-6 mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-purple-50 rounded-xl">
                                <div class="text-3xl font-bold text-purple-600" id="stat-total">0</div>
                                <div class="text-sm text-purple-600">Total</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-xl">
                                <div class="text-3xl font-bold text-green-600" id="stat-avg">0</div>
                                <div class="text-sm text-green-600">Average</div>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                <div class="text-3xl font-bold text-blue-600" id="stat-best">0</div>
                                <div class="text-sm text-blue-600">Best</div>
                            </div>
                            <div class="text-center p-4 bg-orange-50 rounded-xl">
                                <div class="text-3xl font-bold text-orange-600" id="stat-week">0</div>
                                <div class="text-sm text-orange-600">This Week</div>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl overflow-hidden">
                        <div class="p-4 border-b bg-gray-50">
                            <h3 class="font-semibold text-gray-800">Recent Results</h3>
                        </div>
                        <div id="history-list" class="divide-y">
                            <div class="p-8 text-center text-gray-500">Loading...</div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const { data, error } = await db
                    .from('results')
                    .select('*, questions(title)')
                    .eq('student_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                const results = data || [];

                // Stats
                if (results.length > 0) {
                    document.getElementById('stat-total').textContent = results.length;
                    document.getElementById('stat-avg').textContent = Math.round(results.reduce((s,r) => s + r.score, 0) / results.length);
                    document.getElementById('stat-best').textContent = Math.max(...results.map(r => r.score));
                    
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    document.getElementById('stat-week').textContent = results.filter(r => new Date(r.created_at) > weekAgo).length;
                }

                const list = document.getElementById('history-list');

                if (results.length === 0) {
                    list.innerHTML = '<div class="p-8 text-center text-gray-500">No practice history yet. Start practicing!</div>';
                    return;
                }

                list.innerHTML = results.map(r => `
                    <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="this.querySelector('.detail').classList.toggle('hidden')">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-800">${r.questions?.title || 'Unknown'}</h4>
                            <span class="text-2xl font-bold ${r.score >= 80 ? 'text-green-600' : r.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">${r.score}</span>
                        </div>
                        <p class="text-sm text-gray-500">${new Date(r.created_at).toLocaleString()}</p>
                        <div class="flex gap-4 text-xs mt-1">
                            <span class="text-blue-600">Grammar: ${r.grammar_score}</span>
                            <span class="text-green-600">Content: ${r.content_score}</span>
                            <span class="text-orange-600">Vocab: ${r.vocabulary_score}</span>
                        </div>
                        <div class="detail hidden mt-3 p-3 bg-gray-100 rounded text-sm text-gray-700">${r.feedback || 'No feedback'}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load history error:', err);
                document.getElementById('history-list').innerHTML = '<div class="p-4 text-center text-red-500">Error loading history</div>';
            }
        }

        // ============================================
        // ADMIN PAGE
        // ============================================
        async function loadAdminPage() {
            document.getElementById('main-content').innerHTML = `
                <div class="fade-in">
                    <h2 class="text-2xl font-bold text-white mb-6">Manage Questions</h2>
                    
                    <div class="glass rounded-2xl p-6 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-4">Add New Question</h3>
                        <div class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                    <select id="new-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Difficulty</label>
                                    <select id="new-difficulty" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                <input type="text" id="new-title" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="e.g., Daily Routine">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Question</label>
                                <textarea id="new-question" class="w-full h-20 px-4 py-2 border border-gray-300 rounded-lg" placeholder="e.g., What do you usually do in the morning?"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Sample Answer (optional)</label>
                                <textarea id="new-sample" class="w-full h-20 px-4 py-2 border border-gray-300 rounded-lg" placeholder="A good example answer..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tip (optional)</label>
                                <input type="text" id="new-tips" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="e.g., Use past tense">
                            </div>
                            <button onclick="addNewQuestion()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:opacity-90">
                                Add Question
                            </button>
                        </div>
                    </div>

                    <div class="glass rounded-2xl overflow-hidden">
                        <div class="p-4 border-b bg-gray-50">
                            <h3 class="font-semibold text-gray-800">All Questions (<span id="question-count">0</span>)</h3>
                        </div>
                        <div id="admin-questions" class="divide-y max-h-96 overflow-y-auto">
                            <div class="p-4 text-center text-gray-500">Loading...</div>
                        </div>
                    </div>
                </div>
            `;

            // Load categories
            const { data: cats } = await db.from('categories').select('*').order('name');
            document.getElementById('new-category').innerHTML = (cats || []).map(c => 
                `<option value="${c.id}">${c.icon || 'üìö'} ${c.name}</option>`
            ).join('');

            // Load questions
            const { data: qs } = await db.from('questions').select('*, categories(name, icon)').order('created_at', { ascending: false });
            
            document.getElementById('question-count').textContent = qs?.length || 0;
            
            const list = document.getElementById('admin-questions');
            if (!qs || qs.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-gray-500">No questions yet</div>';
                return;
            }

            list.innerHTML = qs.map(q => `
                <div class="p-4 hover:bg-gray-50 flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span>${q.categories?.icon || 'üìö'}</span>
                            <span class="font-medium text-gray-800">${q.title}</span>
                            <span class="text-xs px-2 py-0.5 rounded-full ${getDifficultyClass(q.difficulty)}">${q.difficulty}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${q.question_text}</p>
                    </div>
                    <button onclick="deleteQuestion('${q.id}')" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        async function addNewQuestion() {
            const categoryId = document.getElementById('new-category').value;
            const title = document.getElementById('new-title').value.trim();
            const question = document.getElementById('new-question').value.trim();
            const difficulty = document.getElementById('new-difficulty').value;
            const sample = document.getElementById('new-sample').value.trim();
            const tips = document.getElementById('new-tips').value.trim();

            if (!title || !question) {
                alert('Please fill in title and question');
                return;
            }

            try {
                const { error } = await db.from('questions').insert({
                    category_id: categoryId,
                    title: title,
                    question_text: question,
                    difficulty: difficulty,
                    sample_answer: sample || null,
                    tips: tips || null,
                    created_by: currentUser.id
                });

                if (error) throw error;

                // Clear form
                document.getElementById('new-title').value = '';
                document.getElementById('new-question').value = '';
                document.getElementById('new-sample').value = '';
                document.getElementById('new-tips').value = '';

                alert('Question added!');
                loadAdminPage();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('Delete this question?')) return;

            try {
                await db.from('questions').delete().eq('id', id);
                loadAdminPage();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function renderAuth() {
            document.getElementById('app').innerHTML = getAuthTemplate();
        }

        function renderDashboard() {
            document.getElementById('app').innerHTML = getDashboardTemplate();

            // Set user info
            document.getElementById('header-user-name').textContent = currentProfile?.full_name || currentUser?.email || 'User';
            document.getElementById('header-user-role').textContent = currentProfile?.role || 'student';

            // Show admin nav for teachers
            if (currentProfile?.role === 'teacher' || currentProfile?.role === 'admin') {
                document.getElementById('nav-admin').classList.remove('hidden');
            }

            navigateTo('practice');
        }

        // ============================================
        // PROFILE LOADER
        // ============================================
        async function loadUserProfile() {
            try {
                const { data } = await db.from('profiles').select('*').eq('id', currentUser.id).single();
                
                if (data) {
                    currentProfile = data;
                } else {
                    currentProfile = {
                        full_name: currentUser.user_metadata?.full_name || currentUser.email,
                        role: currentUser.user_metadata?.role || 'student'
                    };
                }
            } catch (err) {
                currentProfile = {
                    full_name: currentUser?.email || 'User',
                    role: 'student'
                };
            }
        }

        // ============================================
        // MAIN INIT
        // ============================================
        async function startApp() {
            // Check config
            if (CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="glass rounded-2xl p-8 max-w-lg text-center">
                            <div class="text-5xl mb-4">‚öôÔ∏è</div>
                            <h1 class="text-2xl font-bold text-gray-800 mb-4">Setup Required</h1>
                            <p class="text-gray-600 mb-4">Please update the CONFIG at the top of the script with your API keys:</p>
                            <div class="bg-gray-100 p-4 rounded-lg text-left text-sm font-mono text-gray-700">
                                <p>SUPABASE_URL: 'https://xxx.supabase.co'</p>
                                <p>SUPABASE_ANON_KEY: 'eyJ...'</p>
                                <p>GEMINI_API_KEY: 'AIza...'</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Init Supabase
            if (!initSupabase()) {
                return;
            }

            // Check session
            try {
                const { data: { session } } = await db.auth.getSession();

                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                    renderDashboard();
                } else {
                    renderAuth();
                }

                // Auth state listener
                db.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth event:', event);
                    if (event === 'SIGNED_IN' && session) {
                        currentUser = session.user;
                        await loadUserProfile();
                        renderDashboard();
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        currentProfile = null;
                        renderAuth();
                    }
                });
            } catch (err) {
                console.error('Session check error:', err);
                renderAuth();
            }
        }

        // Wait for page load then start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startApp);
        } else {
            startApp();
        }
    </script>
</body>
</html>